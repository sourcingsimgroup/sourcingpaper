<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sourcing Paper – Tools Screening Applicant</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS untuk export Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#dc2626;
      --line:#e5e7eb;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.5;
      padding:16px;
    }
    h1{
      font-size:1.6rem;
      font-weight:700;
      margin-bottom:4px;
    }
    .subhead{
      font-size:.9rem;
      color:var(--muted);
    }
    .shell{
      max-width:1400px;
      margin:0 auto;
    }
    .layout{
      display:grid;
      grid-template-columns:minmax(0,420px) minmax(0,1fr);
      gap:16px;
      margin-top:16px;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(15,23,42,.06);
      padding:16px 18px;
      border:1px solid #e5e7eb;
    }
    .card-title{
      font-weight:600;
      font-size:1rem;
      margin-bottom:4px;
    }
    .card-sub{
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:12px;
    }
    form{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:calc(100vh - 160px);
      overflow:auto;
      padding-right:4px;
    }
    .field-group{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px 12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }
    .field label{
      font-weight:600;
      font-size:.78rem;
    }
    .field small{
      font-size:.7rem;
      color:var(--muted);
    }
    input,select,textarea{
      font:inherit;
      padding:6px 8px;
      border-radius:9px;
      border:1px solid var(--line);
      background:#f9fafb;
      outline:none;
      transition:.15s border-color,.15s box-shadow,.15s background;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
      background:#fff;
    }
    input[disabled]{
      background:#f3f4f6;
      color:#9ca3af;
    }
    textarea{
      resize:vertical;
      min-height:60px;
    }
    .actions-line{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:7px 16px;
      font-size:.8rem;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.15s transform,.15s box-shadow,.15s background;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--brand);
      color:#fff;
      box-shadow:0 8px 18px rgba(37,99,235,.25);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(37,99,235,.28);
    }
    .btn-ghost{
      background:transparent;
      color:var(--muted);
    }
    .btn-ghost:hover{
      background:#f3f4f6;
    }
    .badge-mode{
      font-size:.72rem;
      padding:4px 9px;
      border-radius:999px;
      background:var(--brand-soft);
      color:var(--brand);
      font-weight:600;
    }

    /* FILTERS & EXPORT */
    .filters{
      margin-top:4px;
      margin-bottom:8px;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      font-size:.75rem;
    }
    .filter-field label,
    .export-group label{
      font-weight:600;
      margin-bottom:3px;
    }
    .filters select,
    .filters input[type="date"]{
      min-width:150px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:.78rem;
    }
    .filters select:focus,
    .filters input[type="date"]:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
      background:#fff;
    }
    .export-group{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .export-buttons{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    /* TABLE */
    .table-wrap{
      margin-top:4px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      overflow:auto;
      background:#fff;
      max-height:calc(100vh - 160px);
    }
    table{
      border-collapse:collapse;
      width:100%;
      min-width:980px;
      font-size:.78rem;
    }
    thead{
      position:sticky;
      top:0;
      z-index:2;
      background:#0f172a;
      color:#e5e7eb;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:600;
      font-size:.72rem;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){
      background:#f9fafb;
    }
    tbody tr:hover{
      background:#eef2ff;
    }
    .mini-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .btn-mini{
      padding:3px 8px;
      border-radius:999px;
      border:none;
      font-size:.7rem;
      cursor:pointer;
      background:#e5e7eb;
    }
    .btn-mini-edit{background:#dbeafe;color:#1d4ed8;}
    .btn-mini-del{background:#fee2e2;color:#b91c1c;}
    a.wa-link{
      color:#16a34a;
      font-weight:600;
      text-decoration:none;
      font-size:.75rem;
    }
    a.wa-link:hover{
      text-decoration:underline;
    }
    .hint{
      font-size:.7rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>Sourcing Paper</h1>
      <div class="subhead">
        Worksheet screening kandidat dalam bentuk web app (CRUD) yang terhubung langsung ke Google Spreadsheet (sheet BRD).
      </div>
    </header>

    <div class="layout">
      <!-- FORM -->
      <section class="card">
        <div class="card-title">Form Sourcing Paper</div>
        <div class="card-sub">
          Tambah / edit data kandidat. Data tersimpan di Spreadsheet (bukan di localStorage).
        </div>

        <div class="actions-line" style="margin-bottom:8px;">
          <span class="badge-mode" id="mode-label">Mode: Tambah baru</span>
          <div class="hint">
            TANGGAL otomatis dari Apps Script saat simpan, ALIAS otomatis dari nama depan.
          </div>
        </div>

        <form id="sourcing-form">
          <!-- Block 1 -->
          <div class="field-group">
            <div class="field">
              <label for="tanggal">TANGGAL</label>
              <input id="tanggal" type="text" placeholder="Otomatis dari server" disabled />
            </div>
            <div class="field">
              <label for="namaPs">Nama PS</label>
              <input id="namaPs" type="text" />
            </div>
            <div class="field">
              <label for="central">Central</label>
              <input id="central" type="text" />
            </div>
            <div class="field">
              <label for="area">AREA</label>
              <select id="area">
                <option value="">-- Pilih Area --</option>
                <option>JABODETABEK</option>
                <option>Bandung</option>
                <option>Semarang</option>
                <option>Surabaya</option>
                <option>Medan</option>
                <option>Makassar</option>
                <option>Lainnya</option>
              </select>
            </div>
          </div>

          <!-- Block 2 -->
          <div class="field-group">
            <div class="field">
              <label for="linkCv">LINK CV</label>
              <input id="linkCv" type="text" placeholder="URL CV (GDrive / lainnya)" />
            </div>
            <div class="field">
              <label for="uploadOrs">Upload ORS</label>
              <select id="uploadOrs">
                <option value="">-- Pilih --</option>
                <option>Sudah</option>
                <option>Belum</option>
              </select>
            </div>
            <div class="field">
              <label for="name">NAME</label>
              <input id="name" type="text" />
            </div>
            <div class="field">
              <label for="alias">ALIAS</label>
              <input id="alias" type="text" placeholder="Otomatis dari nama depan" />
            </div>
          </div>

          <!-- Block 3 -->
          <div class="field-group">
            <div class="field">
              <label for="email">EMAIL</label>
              <input id="email" type="email" />
            </div>
            <div class="field">
              <label for="kotaLahir">KOTA LAHIR</label>
              <input id="kotaLahir" type="text" />
            </div>
            <div class="field">
              <label for="tahunLahir">TAHUN LAHIR (Tgl Lahir)</label>
              <input id="tahunLahir" type="date" />
            </div>
            <div class="field">
              <label for="gender">GENDER</label>
              <select id="gender">
                <option value="">-- Pilih --</option>
                <option>Laki-Laki</option>
                <option>Perempuan</option>
              </select>
            </div>
          </div>

          <!-- Block 4 -->
          <div class="field-group">
            <div class="field">
              <label for="religion">RELIGION</label>
              <select id="religion">
                <option value="">-- Pilih --</option>
                <option>Islam</option>
                <option>Kristen</option>
                <option>Katolik</option>
                <option>Hindu</option>
                <option>Budha</option>
                <option>Konghucu</option>
                <option>Lainnya</option>
              </select>
            </div>
            <div class="field">
              <label for="kotaDomisili">Kota Domisili</label>
              <input id="kotaDomisili" type="text" />
            </div>
            <div class="field">
              <label for="pendidikan">PENDIDIKAN</label>
              <select id="pendidikan">
                <option value="">-- Pilih --</option>
                <option>SMA/SMK</option>
                <option>D1</option>
                <option>D2</option>
                <option>D3</option>
                <option>S1</option>
                <option>S2</option>
                <option>S3</option>
              </select>
            </div>
            <div class="field">
              <label for="sekolahUniv">SEKOLAH / UNIV</label>
              <input id="sekolahUniv" type="text" />
            </div>
          </div>

          <!-- Block 5 -->
          <div class="field-group">
            <div class="field">
              <label for="sumberSourcing">SUMBER SOURCING</label>
              <select id="sumberSourcing">
                <option value="">-- Pilih --</option>
                <option>SIM Talent Search</option>
                <option>Referensi Teman/Keluarga</option>
                <option>Jobstreet</option>
                <option>LinkedIn</option>
                <option>Kalibrr</option>
                <option>Karir.com</option>
                <option>Ex TAD</option>
                <option>Gawe.id</option>
                <option>Whatsapp</option>
                <option>Drop CV</option>
                <option>Forum Lowongan Kerja</option>
                <option>FLK</option>
                <option>Lainnya</option>
              </select>
            </div>
            <div class="field">
              <label for="industry">INDUSTRY</label>
              <select id="industry">
                <option value="">-- Pilih --</option>
                <option>Multifinance Fintech - LO</option>
                <option>Multifinance Fintech - Non LO</option>
                <option>Banking</option>
                <option>Retail</option>
                <option>FMCG</option>
                <option>Manufacture</option>
                <option>Logistic</option>
                <option>General Industry</option>
                <option>Contact Center</option>
                <option>Talent Pool Elektronik</option>
                <option>Lainnya</option>
              </select>
            </div>
            <div class="field">
              <label for="jobPosisi">JOB POSISI</label>
              <input id="jobPosisi" type="text" />
            </div>
            <div class="field">
              <label for="provinsiMinat">PROVINSI MINAT</label>
              <select id="provinsiMinat">
                <option value="">Memuat dari provinsi_kota.json...</option>
              </select>
            </div>
          </div>

          <!-- Block 6 -->
          <div class="field-group">
            <div class="field">
              <label for="kotaMinat">KOTA MINAT PENEMPATAN</label>
              <select id="kotaMinat">
                <option value="">Pilih provinsi terlebih dahulu</option>
              </select>
            </div>
            <div class="field">
              <label for="groupAplikan">GROUP APLIKAN</label>
              <select id="groupAplikan">
                <option value="">-- Pilih --</option>
                <option>Aplikan Valid Submit</option>
                <option>Aplikan Valid Stock</option>
                <option>Aplikan Valid FIFGROUP</option>
                <option>Lainnya</option>
              </select>
            </div>
            <div class="field">
              <label for="phone1">PHONE 1</label>
              <input id="phone1" type="tel" placeholder="Contoh: 0812xxxx" />
            </div>
            <div class="field">
              <label for="phone2">PHONE 2 / LINK ZOOM</label>
              <input id="phone2" type="text" />
            </div>
          </div>

          <!-- Block 7 -->
          <div class="field-group">
            <div class="field">
              <label for="parameter">PARAMETER</label>
              <select id="parameter">
                <option value="">-- Pilih --</option>
                <option>CTC 1</option>
                <option>CTC 2</option>
                <option>BPH 1</option>
                <option>BPH 2</option>
                <option>UTC 1</option>
                <option>UTC 2</option>
                <option>MSG</option>
              </select>
            </div>
            <div class="field">
              <label for="expectedSalary">EXPECTED SALARY</label>
              <input id="expectedSalary" type="number" min="0" step="100000" placeholder="contoh: 6000000" />
            </div>
            <div class="field">
              <label for="statusApplicant">STATUS APPLICANT</label>
              <select id="statusApplicant">
                <option value="">-- Pilih --</option>
                <option>Submit</option>
                <option>Tidak Submit</option>
              </select>
            </div>
            <div class="field">
              <label for="reasonTidakSubmit">REASON TIDAK SUBMIT</label>
              <select id="reasonTidakSubmit">
                <option value="">-- Pilih Reason --</option>
                <option>Terhubung - One Month Notice</option>
                <option>Terhubung - Withdrawn</option>
                <option>Terhubung - Location Issue</option>
                <option>Terhubung - Salary Issue</option>
                <option>Terhubung - Not Available (sudah bekerja)</option>
                <option>Terhubung - Not Fit (kualifikasi tidak sesuai)</option>
                <option>Terhubung - Berkas Kurang Lengkap</option>
                <option>Lainnya</option>
              </select>
            </div>
          </div>

          <div class="actions-line">
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button type="submit" class="btn btn-primary" id="submit-btn">Simpan Data</button>
              <button type="button" class="btn btn-ghost" id="reset-btn">Bersihkan Form</button>
            </div>
          </div>
        </form>
      </section>

      <!-- TABEL + FILTER -->
      <section class="card">
        <div class="card-title">Worksheet Data Kandidat</div>
        <div class="card-sub">
          Data langsung diambil dari Spreadsheet. Scroll ke kanan untuk lihat semua kolom.
        </div>

        <!-- FILTERS & EXPORT -->
        <div class="filters">
          <div class="filters-row">
            <div class="filter-field">
              <label for="filter-area">AREA</label>
              <select id="filter-area">
                <option value="">Semua AREA</option>
              </select>
            </div>
            <div class="filter-field">
              <label for="filter-industry">INDUSTRY</label>
              <select id="filter-industry">
                <option value="">Semua INDUSTRY</option>
              </select>
            </div>
            <div class="filter-field">
              <label for="filter-status">STATUS APPLICANT</label>
              <select id="filter-status">
                <option value="">Semua STATUS</option>
              </select>
            </div>
            <div class="filter-field">
              <label for="filter-provinsi">PROVINSI MINAT</label>
              <select id="filter-provinsi">
                <option value="">Semua PROVINSI</option>
              </select>
            </div>
            <div class="filter-field">
              <label for="filter-kota">KOTA MINAT</label>
              <select id="filter-kota">
                <option value="">Semua KOTA</option>
              </select>
            </div>
            <div class="filter-field">
              <label>TANGGAL (From / To)</label>
              <div style="display:flex;gap:4px;">
                <input type="date" id="filter-date-from">
                <input type="date" id="filter-date-to">
              </div>
            </div>
            <div class="export-group">
              <label>Export Data</label>
              <div class="export-buttons">
                <button type="button" class="btn btn-ghost" id="export-csv-btn">CSV</button>
                <button type="button" class="btn btn-ghost" id="export-xlsx-btn">Excel</button>
              </div>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr id="header-row"></tr>
            </thead>
            <tbody id="data-body"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    /**************** CONFIG ****************/
    const API_URL = 'https://script.google.com/macros/s/AKfycbyUOTlHzqFLWbHLebdqdApYyPZYP3IjOx_GApxO2NISgl4Gfv44GfuKwJQtz01XNp4K/exec'; // <-- ganti dengan URL Web App /exec kamu

    let PROVINSI_KOTA = {};
    let records = [];
    let editIndex = null;

    // Filter state
    let filterArea = "";
    let filterIndustry = "";
    let filterStatus = "";
    let filterProvinsi = "";
    let filterKota = "";
    let filterDateFrom = "";
    let filterDateTo = "";

    const FORM_FIELDS = [
      "tanggal",
      "namaPs",
      "central",
      "area",
      "linkCv",
      "uploadOrs",
      "name",
      "alias",
      "email",
      "kotaLahir",
      "tahunLahir",
      "gender",
      "religion",
      "kotaDomisili",
      "pendidikan",
      "sekolahUniv",
      "sumberSourcing",
      "industry",
      "jobPosisi",
      "provinsiMinat",
      "kotaMinat",
      "groupAplikan",
      "phone1",
      "phone2",
      "parameter",
      "expectedSalary",
      "statusApplicant",
      "reasonTidakSubmit"
    ];

    const TABLE_FIELDS = [
      { key: "tanggal",           label: "TANGGAL" },
      { key: "namaPs",            label: "Nama PS" },
      { key: "central",           label: "Central" },
      { key: "area",              label: "AREA" },
      { key: "linkCv",            label: "Link CV" },
      { key: "uploadOrs",         label: "Upload ORS" },
      { key: "name",              label: "NAME" },
      { key: "alias",             label: "ALIAS" },
      { key: "email",             label: "EMAIL" },
      { key: "kotaLahir",         label: "KOTA LAHIR" },
      { key: "tahunLahir",        label: "TAHUN LAHIR" },
      { key: "gender",            label: "GENDER" },
      { key: "religion",          label: "RELIGION" },
      { key: "kotaDomisili",      label: "Kota Domisili" },
      { key: "pendidikan",        label: "PENDIDIKAN" },
      { key: "sekolahUniv",       label: "SEKOLAH/UNIV" },
      { key: "sumberSourcing",    label: "SUMBER SOURCING" },
      { key: "industry",          label: "INDUSTRY" },
      { key: "jobPosisi",         label: "JOB POSISI" },
      { key: "provinsiMinat",     label: "PROVINSI MINAT" },
      { key: "kotaMinat",         label: "KOTA MINAT" },
      { key: "groupAplikan",      label: "GROUP APLIKAN" },
      { key: "phone1",            label: "PHONE 1" },
      { key: "call1",             label: "CALL 1 (WA)" },
      { key: "phone2",            label: "PHONE 2 / LINK ZOOM" },
      { key: "parameter",         label: "PARAMETER" },
      { key: "expectedSalary",    label: "EXPECTED SALARY" },
      { key: "statusApplicant",   label: "STATUS APPLICANT" },
      { key: "reasonTidakSubmit", label: "REASON TIDAK SUBMIT" }
    ];

    function initTableHeader(){
      const tr = document.getElementById("header-row");
      tr.innerHTML = "";
      TABLE_FIELDS.forEach(f=>{
        const th = document.createElement("th");
        th.textContent = f.label;
        tr.appendChild(th);
      });
      const thAct = document.createElement("th");
      thAct.textContent = "AKSI";
      tr.appendChild(thAct);
    }

    function makeWaNumber(phoneRaw){
      if(!phoneRaw) return "";
      let num = phoneRaw.replace(/[^\d]/g,"");
      if(!num) return "";
      if(num.startsWith("0")){
        num = "62" + num.slice(1);
      }else if(!num.startsWith("62")){
        // biarkan saja
      }
      return num;
    }
    function makeWaLink(phoneRaw){
      const waNum = makeWaNumber(phoneRaw);
      if(!waNum) return "";
      return "https://wa.me/" + waNum;
    }

    /*************** API CALLS (form-encoded) ***************/
    async function apiList(){
      const resp = await fetch(API_URL + '?action=list');
      const json = await resp.json();
      if(!json.ok) throw new Error(json.error || 'List failed');
      return json.records || [];
    }

    function buildPayloadBody(obj){
      const encoded = encodeURIComponent(JSON.stringify(obj));
      return 'payload=' + encoded;
    }

    async function apiAdd(data){
      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: buildPayloadBody({ action:'add', data })
      });
      const json = await resp.json();
      if(!json.ok) throw new Error(json.error || 'Add failed');
      return json.record;
    }

    async function apiUpdate(data){
      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: buildPayloadBody({ action:'update', data })
      });
      const json = await resp.json();
      if(!json.ok) throw new Error(json.error || 'Update failed');
      return json.record;
    }

    async function apiDelete(rowNumber){
      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: buildPayloadBody({ action:'delete', data:{ rowNumber } })
      });
      const json = await resp.json();
      if(!json.ok) throw new Error(json.error || 'Delete failed');
      return true;
    }

    async function loadRecordsFromApi(){
      try{
        records = await apiList();
        updateFilterOptions();
        renderTable();
      }catch(e){
        console.error(e);
        alert('Gagal memuat data dari Spreadsheet: ' + e.message);
      }
    }

    /*************** FILTER ***************/
    function getFilteredRecords(){
      return records.filter(r=>{
        if(filterArea && (r.area || "") !== filterArea) return false;
        if(filterIndustry && (r.industry || "") !== filterIndustry) return false;
        if(filterStatus && (r.statusApplicant || "") !== filterStatus) return false;
        if(filterProvinsi && (r.provinsiMinat || "") !== filterProvinsi) return false;
        if(filterKota && (r.kotaMinat || "") !== filterKota) return false;

        if(filterDateFrom || filterDateTo){
          const t = (r.tanggal || "").toString().slice(0,10);
          if(filterDateFrom && t < filterDateFrom) return false;
          if(filterDateTo && t > filterDateTo) return false;
        }
        return true;
      });
    }

    function updateFilterOptions(){
      const areaSelect     = document.getElementById("filter-area");
      const industrySelect = document.getElementById("filter-industry");
      const statusSelect   = document.getElementById("filter-status");
      const provSelect     = document.getElementById("filter-provinsi");
      const kotaSelect     = document.getElementById("filter-kota");

      const areas     = new Set();
      const industries= new Set();
      const statuses  = new Set();
      const provs     = new Set();
      const kotas     = new Set();

      records.forEach(r=>{
        if(r.area)            areas.add(r.area);
        if(r.industry)        industries.add(r.industry);
        if(r.statusApplicant) statuses.add(r.statusApplicant);
        if(r.provinsiMinat)   provs.add(r.provinsiMinat);
        if(r.kotaMinat)       kotas.add(r.kotaMinat);
      });

      function fillSelect(select, values, currentValue, labelAll){
        const oldVal = currentValue || "";
        select.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = labelAll;
        select.appendChild(optAll);
        Array.from(values).sort().forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });
        select.value = oldVal;
      }

      fillSelect(areaSelect, areas, filterArea, "Semua AREA");
      fillSelect(industrySelect, industries, filterIndustry, "Semua INDUSTRY");
      fillSelect(statusSelect, statuses, filterStatus, "Semua STATUS");
      fillSelect(provSelect, provs, filterProvinsi, "Semua PROVINSI");
      fillSelect(kotaSelect, kotas, filterKota, "Semua KOTA");
    }

    function initFilterEvents(){
      const areaSelect     = document.getElementById("filter-area");
      const industrySelect = document.getElementById("filter-industry");
      const statusSelect   = document.getElementById("filter-status");
      const provSelect     = document.getElementById("filter-provinsi");
      const kotaSelect     = document.getElementById("filter-kota");
      const dateFromInput  = document.getElementById("filter-date-from");
      const dateToInput    = document.getElementById("filter-date-to");

      const handler = ()=>{
        filterArea     = areaSelect.value || "";
        filterIndustry = industrySelect.value || "";
        filterStatus   = statusSelect.value || "";
        filterProvinsi = provSelect.value || "";
        filterKota     = kotaSelect.value || "";
        filterDateFrom = dateFromInput.value || "";
        filterDateTo   = dateToInput.value || "";
        renderTable();
      };

      areaSelect.addEventListener("change", handler);
      industrySelect.addEventListener("change", handler);
      statusSelect.addEventListener("change", handler);
      provSelect.addEventListener("change", handler);
      kotaSelect.addEventListener("change", handler);
      dateFromInput.addEventListener("change", handler);
      dateToInput.addEventListener("change", handler);
    }

    /*************** PROVINSI – KOTA ***************/
    function populateKotaSelect(prov, selectedCity){
      const kotaSelect = document.getElementById("kotaMinat");
      kotaSelect.innerHTML = '<option value="">-- Pilih Kota --</option>';
      if(!prov || !PROVINSI_KOTA[prov]) return;
      PROVINSI_KOTA[prov].forEach(city=>{
        const opt = document.createElement("option");
        opt.value = city;
        opt.textContent = city;
        kotaSelect.appendChild(opt);
      });
      if(selectedCity){
        kotaSelect.value = selectedCity;
      }
    }

    function initProvinsiKotaDropdown(){
      const provSelect = document.getElementById("provinsiMinat");
      const kotaSelect = document.getElementById("kotaMinat");

      provSelect.innerHTML = '<option value="">-- Pilih Provinsi --</option>';

      const provs = Object.keys(PROVINSI_KOTA || {}).sort();
      if(provs.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Data provinsi belum dimuat";
        provSelect.appendChild(opt);
        kotaSelect.innerHTML = '<option value="">Pilih provinsi terlebih dahulu</option>';
        return;
      }

      provs.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        provSelect.appendChild(opt);
      });

      kotaSelect.innerHTML = '<option value="">Pilih provinsi terlebih dahulu</option>';
    }

    function loadProvinsiKotaFromJson(){
      fetch("provinsi_kota.json")
        .then(res => res.json())
        .then(data=>{
          PROVINSI_KOTA = data || {};
          initProvinsiKotaDropdown();
        })
        .catch(err=>{
          console.warn("Gagal load provinsi_kota.json:", err);
          PROVINSI_KOTA = {};
          initProvinsiKotaDropdown();
        });
    }

    /*************** TABEL ***************/
    function renderTable(){
      const tbody = document.getElementById("data-body");
      tbody.innerHTML = "";

      const dataToRender = getFilteredRecords();

      if(dataToRender.length === 0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = TABLE_FIELDS.length + 1;
        td.textContent = "Belum ada data (atau tidak ada yang cocok dengan filter).";
        td.style.textAlign = "center";
        td.style.color = "#6b7280";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      dataToRender.forEach((rec)=>{
        const tr = document.createElement("tr");

        TABLE_FIELDS.forEach(field=>{
          const td = document.createElement("td");
          if(field.key === "call1"){
            const link = rec.call1 || makeWaLink(rec.phone1);
            if(link){
              const a = document.createElement("a");
              a.href = link;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.className = "wa-link";
              a.textContent = "Chat WA";
              td.appendChild(a);
            }else{
              td.textContent = "-";
            }
          }else{
            let val = rec[field.key] ?? "";
            td.textContent = val;
          }
          tr.appendChild(td);
        });

        const tdAct = document.createElement("td");
        const wrap = document.createElement("div");
        wrap.className = "mini-actions";

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "btn-mini btn-mini-edit";
        btnEdit.textContent = "Edit";
        btnEdit.onclick = ()=> startEditByRowNumber(rec.rowNumber);

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "btn-mini btn-mini-del";
        btnDel.textContent = "Hapus";
        btnDel.onclick = ()=> deleteRecord(rec.rowNumber);

        wrap.appendChild(btnEdit);
        wrap.appendChild(btnDel);
        tdAct.appendChild(wrap);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });
    }

    function resetForm(){
      FORM_FIELDS.forEach(key=>{
        const el = document.getElementById(key);
        if(!el) return;
        if(el.tagName === "SELECT" || el.tagName === "INPUT" || el.tagName === "TEXTAREA"){
          el.value = "";
        }
      });
      populateKotaSelect("", "");
      editIndex = null;
      document.getElementById("tanggal").value = "";
      document.getElementById("mode-label").textContent = "Mode: Tambah baru";
      document.getElementById("submit-btn").textContent = "Simpan Data";
    }

    function fillFormFromRecord(rec){
      document.getElementById("tanggal").value = rec.tanggal || "";
      document.getElementById("namaPs").value = rec.namaPs || "";
      document.getElementById("central").value = rec.central || "";
      document.getElementById("area").value = rec.area || "";
      document.getElementById("linkCv").value = rec.linkCv || "";
      document.getElementById("uploadOrs").value = rec.uploadOrs || "";
      document.getElementById("name").value = rec.name || "";
      document.getElementById("alias").value = rec.alias || "";
      document.getElementById("email").value = rec.email || "";
      document.getElementById("kotaLahir").value = rec.kotaLahir || "";
      document.getElementById("tahunLahir").value = rec.tahunLahir || "";
      document.getElementById("gender").value = rec.gender || "";
      document.getElementById("religion").value = rec.religion || "";
      document.getElementById("kotaDomisili").value = rec.kotaDomisili || "";
      document.getElementById("pendidikan").value = rec.pendidikan || "";
      document.getElementById("sekolahUniv").value = rec.sekolahUniv || "";
      document.getElementById("sumberSourcing").value = rec.sumberSourcing || "";
      document.getElementById("industry").value = rec.industry || "";
      document.getElementById("jobPosisi").value = rec.jobPosisi || "";
      document.getElementById("provinsiMinat").value = rec.provinsiMinat || "";
      populateKotaSelect(rec.provinsiMinat || "", rec.kotaMinat || "");
      document.getElementById("groupAplikan").value = rec.groupAplikan || "";
      document.getElementById("phone1").value = rec.phone1 || "";
      document.getElementById("phone2").value = rec.phone2 || "";
      document.getElementById("parameter").value = rec.parameter || "";
      document.getElementById("expectedSalary").value = rec.expectedSalary || "";
      document.getElementById("statusApplicant").value = rec.statusApplicant || "";
      document.getElementById("reasonTidakSubmit").value = rec.reasonTidakSubmit || "";
    }

    function collectFormData(){
      return {
        namaPs:          document.getElementById("namaPs").value.trim(),
        central:         document.getElementById("central").value.trim(),
        area:            document.getElementById("area").value.trim(),
        linkCv:          document.getElementById("linkCv").value.trim(),
        uploadOrs:       document.getElementById("uploadOrs").value.trim(),
        name:            document.getElementById("name").value.trim(),
        alias:           document.getElementById("alias").value.trim(),
        email:           document.getElementById("email").value.trim(),
        kotaLahir:       document.getElementById("kotaLahir").value.trim(),
        tahunLahir:      document.getElementById("tahunLahir").value.trim(),
        gender:          document.getElementById("gender").value.trim(),
        religion:        document.getElementById("religion").value.trim(),
        kotaDomisili:    document.getElementById("kotaDomisili").value.trim(),
        pendidikan:      document.getElementById("pendidikan").value.trim(),
        sekolahUniv:     document.getElementById("sekolahUniv").value.trim(),
        sumberSourcing:  document.getElementById("sumberSourcing").value.trim(),
        industry:        document.getElementById("industry").value.trim(),
        jobPosisi:       document.getElementById("jobPosisi").value.trim(),
        provinsiMinat:   document.getElementById("provinsiMinat").value.trim(),
        kotaMinat:       document.getElementById("kotaMinat").value.trim(),
        groupAplikan:    document.getElementById("groupAplikan").value.trim(),
        phone1:          document.getElementById("phone1").value.trim(),
        phone2:          document.getElementById("phone2").value.trim(),
        parameter:       document.getElementById("parameter").value.trim(),
        expectedSalary:  document.getElementById("expectedSalary").value.trim(),
        statusApplicant: document.getElementById("statusApplicant").value.trim(),
        reasonTidakSubmit: document.getElementById("reasonTidakSubmit").value.trim()
      };
    }

    function startEditByRowNumber(rowNumber){
      const idx = records.findIndex(r=> r.rowNumber === rowNumber);
      if(idx === -1) return;
      editIndex = idx;
      const rec = records[idx];
      fillFormFromRecord(rec);
      document.getElementById("mode-label").textContent = "Mode: Edit baris (row " + rowNumber + ")";
      document.getElementById("submit-btn").textContent = "Update Data";
      const formEl = document.getElementById("sourcing-form");
      if(formEl && formEl.scrollIntoView){
        formEl.scrollIntoView({behavior:"smooth",block:"start"});
      }
    }

    async function deleteRecord(rowNumber){
      if(!confirm("Yakin ingin menghapus baris ini di Spreadsheet?")) return;
      try{
        await apiDelete(rowNumber);
        await loadRecordsFromApi();
        resetForm();
      }catch(e){
        console.error(e);
        alert("Gagal hapus data: " + e.message);
      }
    }

    /*************** EXPORT ***************/
    function exportToCSV(){
      const dataToExport = getFilteredRecords();
      if(!dataToExport.length){
        alert("Tidak ada data untuk diexport.");
        return;
      }
      const header = TABLE_FIELDS.map(f=>f.label);
      const rows = dataToExport.map(rec => TABLE_FIELDS.map(f=>{
        if(f.key === "call1") return makeWaLink(rec.phone1);
        return rec[f.key] ?? "";
      }));

      function escapeCSV(value){
        if(value == null) return "";
        const s = String(value).replace(/"/g,'""');
        if(/[",\n]/.test(s)) return `"${s}"`;
        return s;
      }

      const lines = [];
      lines.push(header.map(escapeCSV).join(","));
      rows.forEach(row=>{
        lines.push(row.map(escapeCSV).join(","));
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "SourcingPaper.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportToXLSX(){
      const dataToExport = getFilteredRecords();
      if(!dataToExport.length){
        alert("Tidak ada data untuk diexport.");
        return;
      }
      const header = TABLE_FIELDS.map(f=>f.label);
      const rows = dataToExport.map(rec => TABLE_FIELDS.map(f=>{
        if(f.key === "call1") return makeWaLink(rec.phone1);
        return rec[f.key] ?? "";
      }));
      const aoa = [header, ...rows];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "SourcingPaper");
      XLSX.writeFile(wb, "SourcingPaper.xlsx");
    }

    /*************** EVENTS ***************/
    function setupEvents(){
      const form = document.getElementById("sourcing-form");
      form.addEventListener("submit", async function(e){
        e.preventDefault();
        const payload = collectFormData();
        try{
          if(editIndex === null){
            await apiAdd(payload);
          }else{
            const rowNumber = records[editIndex].rowNumber;
            await apiUpdate(Object.assign({}, payload, { rowNumber }));
          }
          await loadRecordsFromApi();
          resetForm();
        }catch(err){
          console.error(err);
          alert("Gagal menyimpan data: " + err.message);
        }
      });

      document.getElementById("reset-btn").addEventListener("click", function(){
        resetForm();
      });

      // Auto-ALIAS dari NAME
      const nameEl = document.getElementById("name");
      const aliasEl = document.getElementById("alias");
      nameEl.addEventListener("input", function(){
        const txt = (this.value || "").trim();
        const first = txt.split(/\s+/)[0] || "";
        aliasEl.value = first ? first.toUpperCase() : "";
      });

      // Provinsi -> Kota
      const provEl = document.getElementById("provinsiMinat");
      provEl.addEventListener("change", function(){
        populateKotaSelect(this.value, "");
      });

      // Export buttons
      document.getElementById("export-csv-btn").addEventListener("click", exportToCSV);
      document.getElementById("export-xlsx-btn").addEventListener("click", exportToXLSX);

      // Filter events
      initFilterEvents();
    }

    // INIT
    (function init(){
      initTableHeader();
      setupEvents();
      loadProvinsiKotaFromJson();
      loadRecordsFromApi();
    })();
  </script>
</body>
</html>
